
# Техническое задание: Универсальный парсер каталогов поставщиков

## 1. Цель и назначение

Создать масштабируемый, интеллектуальный парсер для автоматического сбора товарных каталогов с сайтов российских поставщиков инструментов и оборудования с использованием ИИ технологий (Claude AI).

## 2. Архитектура системы

### 2.1 Основные компоненты
- **Планировщик задач** - управление расписанием парсинга
- **Анализатор сайтов** - определение структуры и навигации
- **ИИ-процессор** - извлечение данных с помощью Claude
- **Валидатор данных** - проверка и очистка извлеченных данных
- **Импортер** - сохранение в базу данных
- **Монитор ошибок** - отслеживание и восстановление

### 2.2 Модульная структура
```
/parser
  /core
    - scheduler.ts       // Планировщик
    - analyzer.ts        // Анализатор сайтов
    - ai-processor.ts    // ИИ обработка
    - validator.ts       // Валидация данных
    - importer.ts        // Импорт в БД
  /suppliers
    - config.ts          // Конфигурации поставщиков
    - adapters/          // Специфичные адаптеры
  /utils
    - logger.ts          // Логирование
    - cache.ts           // Кеширование
    - retry.ts           // Повторные попытки
```

## 3. Алгоритм работы

### 3.1 Этап 1: Анализ структуры сайта
1. **Загрузка главной страницы**
   - Получение HTML с обходом защиты
   - Анализ структуры навигации
   - Поиск ссылок на каталоги

2. **Картирование каталога**
   - Определение категорий товаров
   - Поиск пагинации
   - Анализ URL-схем

3. **Планирование маршрута**
   - Составление списка страниц для парсинга
   - Оптимизация последовательности обхода

### 3.2 Этап 2: Сбор данных
1. **Извлечение HTML**
   - Соблюдение задержек между запросами
   - Ротация User-Agent
   - Обработка ошибок сети

2. **ИИ анализ с Claude**
   - Очистка HTML от лишних элементов
   - Извлечение структурированных данных
   - Нормализация информации

### 3.3 Этап 3: Обработка и сохранение
1. **Валидация данных**
   - Проверка обязательных полей
   - Удаление дубликатов
   - Нормализация цен и артикулов

2. **Импорт в базу**
   - Создание/обновление категорий
   - Массовый импорт товаров
   - Обновление связей

## 4. Структура данных товара

### 4.1 Обязательные поля
```typescript
interface ProductData {
  name: string;                    // Полное название товара
  sku: string;                     // Уникальный артикул
  price: string;                   // Цена в рублях
  category: string;                // Категория товара
  description: string;             // Описание товара
  sourceUrl: string;               // URL источника
  supplierName: string;            // Название поставщика
}
```

### 4.2 Дополнительные поля
```typescript
interface ExtendedProductData extends ProductData {
  originalPrice?: string;          // Первоначальная цена
  imageUrl?: string;               // Ссылка на изображение
  imageUrls?: string[];            // Дополнительные изображения
  brand?: string;                  // Бренд/производитель
  model?: string;                  // Модель товара
  specifications?: string;         // Технические характеристики
  features?: string[];             // Особенности товара
  warranty?: string;               // Гарантия
  availability?: string;           // Наличие на складе
  stock?: number;                  // Количество на складе
  technicalSpecs?: Record<string, string>; // Детальные характеристики
}
```

## 5. Конфигурация поставщиков

### 5.1 Базовая конфигурация
```typescript
interface SupplierConfig {
  id: string;                      // Уникальный ID поставщика
  name: string;                    // Название поставщика
  baseUrl: string;                 // Базовый URL сайта
  catalogUrls: string[];           // Ссылки на каталоги
  updateInterval: number;          // Интервал обновления (часы)
  isActive: boolean;               // Активность поставщика
  settings: SupplierSettings;
}

interface SupplierSettings {
  delay: number;                   // Задержка между запросами (мс)
  maxPages: number;                // Максимум страниц за сессию
  timeout: number;                 // Таймаут запроса (мс)
  userAgent?: string;              // Специальный User-Agent
  headers?: Record<string, string>; // Дополнительные заголовки
  retryAttempts: number;           // Количество повторных попыток
  selectors?: SiteSelectors;       // CSS селекторы для специфичных сайтов
}

interface SiteSelectors {
  productContainer: string;        // Контейнер товаров
  productName: string;             // Название товара
  productPrice: string;            // Цена товара
  productImage: string;            // Изображение товара
  productLink: string;             // Ссылка на товар
  nextPage?: string;               // Ссылка "Следующая страница"
}
```

## 6. ИИ промпты для Claude

### 6.1 Промпт для анализа структуры сайта
```
Проанализируй HTML код сайта поставщика инструментов и определи:
1. Структуру навигации по каталогу
2. Ссылки на основные категории товаров
3. Схему пагинации
4. Основные CSS селекторы для товаров

Верни результат в JSON формате с полной структурой сайта.
```

### 6.2 Промпт для извлечения товаров
```
Извлеки ВСЕ товары из HTML страницы каталога российского поставщика инструментов.

ОБЯЗАТЕЛЬНЫЕ ПОЛЯ для каждого товара:
- name: полное название на русском языке
- sku: артикул товара (если нет - создай уникальный)
- price: цена в рублях (только числа)
- category: категория товара
- description: описание товара

ДОПОЛНИТЕЛЬНЫЕ ПОЛЯ (если доступны):
- originalPrice: старая цена при скидке
- imageUrl: ссылка на изображение
- brand: производитель
- model: модель
- specifications: технические характеристики
- warranty: гарантия
- availability: наличие на складе

Верни только JSON массив товаров без дополнительного текста.
```

## 7. Обработка ошибок

### 7.1 Типы ошибок и их обработка
- **Сетевые ошибки**: Повторные попытки с экспоненциальной задержкой
- **Блокировки сайтов**: Ротация User-Agent, изменение интервалов
- **Ошибки парсинга**: Fallback на демо-данные, логирование
- **Ошибки ИИ**: Повторный запрос с упрощенным промптом
- **Ошибки базы данных**: Транзакционный откат, уведомления

### 7.2 Система мониторинга
```typescript
interface ParsingStats {
  supplierId: string;
  startTime: Date;
  endTime?: Date;
  status: 'running' | 'completed' | 'failed';
  pagesProcessed: number;
  productsFound: number;
  productsImported: number;
  errors: ErrorLog[];
}

interface ErrorLog {
  timestamp: Date;
  type: 'network' | 'parsing' | 'ai' | 'database';
  message: string;
  url?: string;
  retry: boolean;
}
```

## 8. Планировщик обновлений

### 8.1 Алгоритм планирования
- Проверка необходимости обновления каждого поставщика
- Приоритизация на основе важности поставщика
- Балансировка нагрузки по времени
- Автоматическое восстановление после ошибок

### 8.2 Управление очередью
```typescript
interface ParsingQueue {
  addSupplier(supplierId: string, priority?: number): void;
  processNext(): Promise<ParsingResult>;
  getQueueStatus(): QueueStatus;
  pauseProcessing(): void;
  resumeProcessing(): void;
}
```

## 9. API для управления

### 9.1 Основные эндпоинты
- `POST /api/parser/start/{supplierId}` - Запуск парсинга поставщика
- `GET /api/parser/status/{supplierId}` - Статус выполнения
- `GET /api/parser/stats` - Общая статистика
- `POST /api/parser/schedule` - Настройка расписания
- `GET /api/parser/logs` - Просмотр логов
- `POST /api/parser/config` - Обновление конфигурации

### 9.2 WebSocket уведомления
Реального времени обновления о ходе парсинга, ошибках и результатах.

## 10. Производительность и оптимизация

### 10.1 Кеширование
- Кеширование HTML страниц на короткий период
- Кеширование результатов ИИ анализа
- Кеширование структуры сайтов

### 10.2 Параллельная обработка
- Одновременный парсинг нескольких поставщиков
- Параллельная обработка страниц одного каталога
- Асинхронная обработка изображений

## 11. Безопасность и этика

### 11.1 Соблюдение robots.txt
Проверка и соблюдение правил robots.txt каждого сайта.

### 11.2 Разумные ограничения
- Минимальные задержки между запросами (2-5 секунд)
- Ограничение количества одновременных соединений
- Уважение к пропускной способности сайтов

## 12. Расширяемость

### 12.1 Адаптеры для специфичных сайтов
Возможность создания специализированных адаптеров для сложных сайтов.

### 12.2 Плагинная архитектура
Система плагинов для добавления новых типов данных и способов обработки.

## 13. Тестирование

### 13.1 Модульные тесты
- Тестирование каждого компонента отдельно
- Мок-данные для ИИ компонентов

### 13.2 Интеграционные тесты
- Тестирование с реальными сайтами поставщиков
- Проверка качества извлеченных данных

---

Этот парсер должен стать основой для автоматизированного сбора и обновления каталогов товаров от российских поставщиков инструментов.
